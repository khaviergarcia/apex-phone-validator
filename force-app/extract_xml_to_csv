import xml.etree.ElementTree as ET
import csv
import requests
import re

# ================= CONFIGURACIÓN =================
# Usamos la URL RAW para obtener el XML limpio, no la página web de GitHub.
XML_URL = "https://raw.githubusercontent.com/google/libphonenumber/master/resources/PhoneNumberMetadata.xml"
OUTPUT_FILENAME = "PhoneMetadata_Upload.csv"

# LISTA DE PAÍSES:
# Agrega aquí los códigos ISO (2 letras) de los países que necesitas.
# Dejar la lista vacía [] descargará TODOS los países
TARGET_COUNTRIES = []
# =================================================

def clean_regex(pattern_text):
    """
    Limpia los patrones del XML. 
    Elimina espacios en blanco y saltos de línea que rompen el regex en Salesforce.
    """
    if not pattern_text:
        return None
    return pattern_text.replace('\n', '').replace(' ', '').strip()

def get_node_pattern(element, tag_name):
    """Busca el tag específico (mobile, fixedLine) y extrae su patrón"""
    found = element.find(tag_name)
    if found is not None:
        national = found.find('nationalNumberPattern')
        if national is not None:
            return clean_regex(national.text)
    return None

def main():
    print(f"1. Descargando XML desde: {XML_URL} ...")
    
    try:
        response = requests.get(XML_URL)
        response.raise_for_status() # Lanza error si la descarga falla
    except Exception as e:
        print(f"❌ Error crítico descargando el archivo: {e}")
        return

    # Parsear el XML
    print("2. Procesando estructura XML...")
    root = ET.fromstring(response.content)
    territories = root.find('territories')

    rows_to_insert = []
    
    for territory in territories.findall('territory'):
        iso_code = territory.get('id')
        country_code = territory.get('countryCode')
        
        # Filtros de seguridad
        if iso_code == '001': continue # Omitir "World" genérico
        
        # Si la lista TARGET_COUNTRIES tiene datos, filtramos. Si está vacía, pasa todo.
        if TARGET_COUNTRIES and iso_code not in TARGET_COUNTRIES:
            continue

        # Extracción de datos
        general_regex = get_node_pattern(territory, 'generalDesc')
        mobile_regex = get_node_pattern(territory, 'mobile')
        fixed_regex = get_node_pattern(territory, 'fixedLine')

        # Lógica de fallback: Si no hay regex específico de móvil, usa el general
        if not mobile_regex: mobile_regex = general_regex
        if not fixed_regex: fixed_regex = general_regex

        # Preparar fila para Custom Metadata Type
        # DeveloperName solo acepta guiones bajos y alfanuméricos
        row = {
            'DeveloperName': f"Region_{iso_code}",
            'Label': f"{iso_code} (+{country_code})",
            'IsoCode__c': iso_code,
            'CountryCode__c': country_code,
            'GeneralDescRegex__c': general_regex,
            'MobileRegex__c': mobile_regex,
            'FixedLineRegex__c': fixed_regex
        }
        rows_to_insert.append(row)

    # Generar CSV
    print(f"3. Generando CSV con {len(rows_to_insert)} registros...")
    
    csv_headers = [
        'DeveloperName', 'MasterLabel', 
        'IsoCode__c', 'CountryCode__c', 
        'GeneralDescRegex__c', 'MobileRegex__c', 'FixedLineRegex__c'
    ]

    try:
        with open(OUTPUT_FILENAME, mode='w', newline='', encoding='utf-8') as file:
            writer = csv.DictWriter(file, fieldnames=csv_headers)
            writer.writeheader()
            writer.writerows(rows_to_insert)
        
        print(f"✅ ¡Éxito! Archivo creado: {OUTPUT_FILENAME}")
        print("   -> Ahora usa 'Custom Metadata Loader' o 'Salesforce Inspector' para importar este CSV.")
        
    except IOError as e:
        print(f"❌ Error escribiendo el archivo CSV: {e}")

if __name__ == "__main__":
    main()